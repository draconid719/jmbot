{% extends "bot/base.html" %}
{% block content %}
{% load static %}
    <div class="container-fluid">
        <div class="row sm-gutters">
            <div class="col-lg-6">
                <div class="table-responsive" >
                    <table class="table table-striped crypt-table-market-cap mt-4">
                      <thead>
                        <tr>
                          <th scope="col" class="text-left pl-2">Name</th>
                          <th scope="col">Price</th>
                          <th scope="col">24 Hour Volume</th>
                          <th scope="col">Change</th>
                          
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td class="text-left pl-2 font-weight-bold"><img src="{% static 'bot/images/coins/btc.png' %}" width="20" class="pr-1 crypt-market-cap-logo" alt="coin"> <a href="{% url 'manual-page' 'BTC-USDT'|slugify %}">BTC/USDT</a></td>
                          <td id="pricebtcusdt"></td>
                          <td id="volumebtcusdt"></td>
                          <td><div style="margin-top: 30%;" id="changebtcusdt"></div></td>
                          
                        </tr>
                        <tr>
                          <td class="text-left pl-2 font-weight-bold"><img src="{% static 'bot/images/coins/eth.png' %}" width="20" class="pr-1 crypt-market-cap-logo" alt="coin"> <a href="{% url 'manual-page' 'ETH-USDT'|slugify %}">ETH/USDT</a></td>
                          
                          <td id="priceethusdt"></td>
                          <td id="volumeethusdt"></td>
                          <td><div style="margin-top: 30%;" id="changeethusdt" class="crypt-up"></div></td>
                          
                        </tr>
                        <tr>
                          <td class="text-left pl-2 font-weight-bold"><img src="{% static 'bot/images/coins/ltc.png' %}" width="20" class="pr-1 crypt-market-cap-logo" alt="coin"> <a href="{% url 'manual-page' 'LTC-USDT'|slugify %}">LTC/USDT</a></td>
                          
                          <td id="priceltcusdt"></td>
                          <td id="volumeltcusdt"></td>
                          <td><div style="margin-top: 30%;" id="changeltcusdt"></div></td>
                          
                        </tr>
                        <tr>
                          
                          <td class="text-left pl-2 font-weight-bold"><img src="{% static 'bot/images/coins/btcc.png' %}" width="20" class="pr-1 crypt-market-cap-logo" alt="coin">  <a href="{% url 'manual-page' 'BCH-USDT'|slugify %}">
                            BCH/USDT
                          </a></td>
                          
                          <td id="pricebchusdt"></td>
                          <td id="volumebchusdt"></td>
                          <td><div style="margin-top: 30%;" id="changebchusdt"></div></td>
                          
                        </tr>
                        <tr>
                          
                          <td class="text-left pl-2 font-weight-bold"><img src="{% static 'bot/images/coins/xrp.png' %}" width="20" class="pr-1 crypt-market-cap-logo" alt="coin">  <a href="{% url 'manual-page' 'XRP-USDT'|slugify %}">
                            XRP/USDT
                          </a></td>
                          
                          <td id="pricexrpusdt"></td>
                          <td id="volumexrpusdt"></td>
                          <td><div style="margin-top: 30%;" id="changexrpusdt"></div></td>
                          
                        </tr>
                        <tr>
                          
                          <td class="text-left pl-2 font-weight-bold"><img src="{% static 'bot/images/coins/eos.png' %}" width="20" class="pr-1 crypt-market-cap-logo" alt="coin">  <a href="{% url 'manual-page' 'EOS-USDT'|slugify %}">
                            EOS/USDT
                          </a></td>
                          
                          <td id="priceeosusdt"></td>
                          <td id="volumeeosusdt"></td>
                          <td><div style="margin-top: 30%;" id="changeeosusdt"></div></td>
                          
                        </tr>
                        <tr>
                          
                          <td class="text-left pl-2 font-weight-bold"><img src="{% static 'bot/images/coins/link.png' %}" width="20" class="pr-1 crypt-market-cap-logo" alt="coin">  <a href="{% url 'manual-page' 'LINK-USDT'|slugify %}">
                            LINK/USDT
                          </a></td>
                          
                          <td id="pricelinkusdt"></td>
                          <td id="volumelinkusdt"></td>
                          <td><div style="margin-top: 30%;" id="changelinkusdt"></div></td>
                          
                        </tr>
                        <tr>
                          
                          <td class="text-left pl-2 font-weight-bold"><img src="{% static 'bot/images/coins/xtz.png' %}" width="20" class="pr-1 crypt-market-cap-logo" alt="coin">  <a href="{% url 'manual-page' 'XTZ-USDT'|slugify %}">
                            XTZ/USDT
                          </a></td>
                          
                          <td id="pricextzusdt"></td>
                          <td id="volumextzusdt"></td>
                          <td><div style="margin-top: 30%;" id="changextzusdt"></div></td>
                          
                        </tr>
                        <!-- <tr>
                          
                          <td class="text-left pl-2 font-weight-bold"><img src="{% static 'bot/images/coins/ltc.png' %}" width="20" class="pr-1 crypt-market-cap-logo" alt="coin">  <a href="{% url 'manual-page' 'LTC-BTC'|slugify %}">
                            LTC/BTC
                          </a></td>
                          
                          <td id="priceltcbtc"></td>
                          <td id="volumeltcbtc"></td>
                          <td><div style="margin-top: 30%;" id="changeltcbtc"></div></td>
                          
                        </tr> -->
                        <!-- <tr>
                          
                          <td class="text-left pl-2 font-weight-bold"><img src="{% static 'bot/images/coins/eth.png' %}" width="20" class="pr-1 crypt-market-cap-logo" alt="coin">  <a href="{% url 'manual-page' 'ETH-BTC'|slugify %}">
                            ETH/BTC
                          </a></td>
                          
                          <td id="priceethbtc"></td>
                          <td id="volumeethbtc"></td>
                          <td><div style="margin-top: 30%;" id="changeethbtc"></div></td>
                          
                        </tr> -->
                        <!-- <tr>
                          
                          <td class="text-left pl-2 font-weight-bold"><img src="{% static 'bot/images/coins/dash.png' %}" width="20" class="pr-1 crypt-market-cap-logo" alt="coin">  <a href="{% url 'manual-page' 'DASH-USDT'|slugify %}">
                            DASH/USDT
                          </a></td>
                          
                          <td id="pricedashusdt"></td>
                          <td id="volumedashusdt"></td>
                          <td><div style="margin-top: 30%;" id="changedashusdt"></div></td>
                          
                        </tr> -->
                        <!-- <tr>
                          
                          <td class="text-left pl-2 font-weight-bold"><img src="{% static 'bot/images/coins/xlm.png' %}" width="20" class="pr-1 crypt-market-cap-logo" alt="coin">  <a href="{% url 'manual-page' 'XLM-USDT'|slugify %}">
                            XLM/USDT
                          </a></td>
                          
                          <td id="pricexlmusdt"></td>
                          <td id="volumexlmusdt"></td>
                          <td><div style="margin-top: 30%;" id="changexlmusdt"></div></td>
                          
                        </tr> -->

                        
                        
                        
                        
                      </tbody>
                    </table>
                </div>
            </div>
            <div class="col-lg-6" style="margin-top: 7px;">
                <div class="row sm-gutters">
                  <div class="col-md-12 pl-2 ml-1">
                        <div id="carousel-pager" class="carousel vert slide crypt-currency-slider mt-3" data-ride="carousel" data-interval="3000"> 
        
                            <!-- Carousel items -->
                            
                            <div class="carousel-inner vertical">
                              <div class="active  carousel-item item">
                                <div class="crypt-slider-content">
                                  <div class="row no-gutters">
                                    <div class="col-xs-4 crypt-slider-balance">
                                      <h6>Base Strategy </h6>
                                      <p>Spread</p>
                                      
                                    </div>
                                    <div class="col-xs-5" >
                                      <div class="crypt-slider-current-status">
                                        <!-- <h3>Performance  <span class="ml-3 crypt-up">+25%</span></h3> -->
                                        <h5>Market:  <span class="ml-3 crypt-down">{{pair}}</span></h5>
                                        <!-- <p><b>LifeTime profit = {{profit}} USD</b></p> -->
                                      </div>
                                    </div>
                                    <div class="col-xs-3 d-xs-none d-sm-block d-md-block d-lg-none d-xl-block" style="margin-top: 30px; margin-left: 30px;">
                                      <div class="crypt-exchange-hints">
                                        <img src="{% static firstexurl %}" class="mt-3" alt="logo" style="width: 50px; height: 50px">        <img src="{% static secexurl %}" class="mt-3" alt="logo" style="width: 50px; height: 50px">
                                        <p class="mb-1 mt-3" style="text-align: center;"><b>{{bots.firstExchange}} - {{bots.secondExchange}}</b></p>
                                      </div>
                                      
                                    </div>

                                  </div>
                                </div>
                              </div>
                          </div>
                          
                          <!-- Controls --> 
                          
                          
                    </div>
                </div>
                    <div class="col-md-6 pr-0">
                        <div class="crypt-fulldiv-linechart mt-4">
                            <h4 class="coinname crypt-yellow"><img src="{% static firstexurl %}" style="width: 50px; height: 50px"> {{bots.firstExchange}}</h4>
                            <div
                                class ="crypt-individual-marketcap"
                                data-charts ="[50,50,50,50,50,50,50,50,50]" 
                                data-bg = "fdddb7"
                                data-border = "f8a036">
                                <canvas></canvas>
                            </div>
                            <div class="coin-meta-data text-center">
                                <h6 id="firstvolume"></h6>
                                <h3 id="firstprice" class="crypt-up">--</h3>
                                <h6 id="firstsymbol"></h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 pl-0">
                        <div class="crypt-fulldiv-linechart mt-4">
                            <h4 class="coinname crypt-green"><img src="{% static secexurl %}" style="width: 50px; height: 50px;"> {{bots.secondExchange}}</h4>
                            <div
                                class ="crypt-individual-marketcap"
                                data-charts ="[50,50,50,50,50,50,50,50,50]" 
                                data-bg = "bfe9cf"
                                data-border = "49c279">
                                <canvas></canvas>
                            </div>
                            <div class="coin-meta-data text-center">
                                <h6 id="secvolume"></h6>
                                <h3 id="secprice" class="crypt-up">--</h3>
                                <h6 id="secsymbol"></h6>
                            </div>
                        </div>
                    </div>
                    
            </div>
        </div>
    </div>
</div>
    <div class="container-fluid" style="margin-top: 20px;">
        <div class="row sm-gutters">
            <div class="col-lg-5">
                <div class="crypt-boxed-area">
                    <h6 class="crypt-bg-head"><b>BOT</b></h6><span style="margin-left: 20px; margin-bottom: 20px;"><b>NB: Paper and Live mode require API keys </b></span><br/>
                    <span style="margin-left: 20px; margin-bottom: 20px;"><b> The input amount should not be higher than your actual exchange balance plus the fees </b><a href="{% url 'faq-page'%}#arbitrage">See more</a></span>
                    
                        <form id="arbitrage-form" method="POST">
                          {% csrf_token %}
                          <div class="crypt-buy-sell-form">
                              <!-- <p>Coin <span class="crypt-up">BTC</span> <span class="fright">Available: <b class="crypt-up">20 BTC</b></span></p> -->
                              <div class="crypt-buy-bot" style="margin-left: 20px; margin-right: 20px; height: 322px">
                                  
                                  <div class="input-group mb-3">
                                      <div class="input-group-prepend">
                                          <span class="input-group-text">Amount</span>
                                      </div>
                                      <input type="number" step="any" min="0" id="amount" class="form-control" required>
                                      <div class="input-group-append">
                                          <span class="input-group-text">{{base}}</span>
                                      </div>
                                  </div>
                                  <div class="form-group">
                                      <div class="form-group">
                                          <select class="form-control" id="mode" required>
                                            <option disabled>Mode</option>
                                            <option id="paper">Paper</option>
                                            <option id="live">Live</option>
                                          </select>
                                      </div>
                                  </div>
                                  <input type="hidden" id="pk" name="pk" value="{{pk}}">
                                  <div class="text-center mt-5 mb-5 crypt-up" style="padding-bottom: 2px">
                                      <p> Elapsed time:</p>
                                      <h4 id="elapsed">Not running</h4>
                                    </div>
                                  
                                  
                                   
                                  <div class="menu-green" style="margin-top: 50px;">
                                      <button style="cursor: pointer;" class="crypt-button-green-full" id="submit">Start</button> 
                                  </div>

                              </div>
                          </div>
                        </form>
                        
                    
                </div>
            </div>
            <div class="col-lg-7">
                <div>
                    <div class="crypt-market-status">
                    <div>
                      <!-- Nav tabs -->
                        <ul class="nav nav-tabs">
                            
                            
                            <li role="presentation"><a href="#transactions" class="active" data-toggle="tab">Transactions</a></li>
                        </ul>

                      <!-- Tab panes -->
                      <div class="tab-content">
                        <div role="tabpanel" class="tab-pane active" id="transactions" style="background-color: #2f3a56;">
                          <div class="table-responsive" style="height: 350px;">
                            <table class="table table-striped">
                              <thead>
                                <tr>
                                  <th scope="col">Time</th>
                                  <th scope="col">Buy Market</th>
                                  <th scope="col">Buy Market Price</th>
                                  <th scope="col">Sell Market</th>
                                  <th scope="col">Sell Market Price</th>
                                  <th scope="col">Currency Pair</th>
                                  <th scope="col">Fee</th>
                                  <th scope="col">Profit</th>
                                </tr>
                              </thead>
                              <tbody id="table-body">
                                
                              </tbody>
                            </table>
                            <div class="no-orders text-center" style="height: 100%;" id="transactionempty" >
                                <img src="{% static 'bot/images/empty.png' %}" alt="no-orders">
                            </div>
                          </div>
                        </div>
                      </div>

                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>

{% endblock content %}

{% block scripts %}
    {{ block.super }}
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/ccxt@1.26.84/dist/ccxt.browser.js"></script>
    <script type="text/javascript">
      var canupdate = true;
      update()
      updateelapsed()
      exchange()
      $(document).ready(function(){
            $.ajax({
                type:'POST',
                url:'/paper/getarblivestatus/',
                data:{  
                    pk:$("#pk").val(),
                    csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val()
                },
                success:function(jsdata){
                    if (jsdata['bot'] == 'true'){
                        
                        document.getElementById("amount").disabled = true;
                        document.getElementById("mode").disabled = true;
                        document.getElementById("submit").innerHTML = 'Stop';
                        document.getElementById("submit").className = 'crypt-button-red-full';
                        // update()
                        // exchange()
                        
                    }
                }
            })
            
        });
      $(document).on('submit','#arbitrage-form',function(e){
            document.getElementById("submit").disabled = true
            e.preventDefault();
            document.getElementById("amount").disabled = true;
            document.getElementById("mode").disabled = true;
            
      
            
            $.ajax({
                type:'POST',
                url:'/paper/getarblivestatus/',
                data:{  
                    pk:$("#pk").val(),
                    csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val()
                },
                success:function(jsdata){
                    if (jsdata['bot'] == 'false'){
                        document.getElementById("submit").innerHTML = '<div class="spinner-border" role="status">' + '<span class="sr-only">Loading...</span>'+ '</div>'
                        setTimeout(changestart,4000)
                        $.ajax({
                            type:'POST',
                            url:'/arbitrage/startlivearbitrage/',
                            data:{  
                                pk:$("#pk").val(),
                                amount:$("#amount").val(),
                                mode:$("#mode").val(),
                                csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val()
                            },
                            //datatype: 'json',
                            success:function(){
                                
                            }
                        })
                        // update()
                        // exchange()
                        
                    }else{
                      
                      setTimeout(changestop,)
                      
                      
                      $.ajax({
                          type:'POST',
                          url:'/paper/stoplivearbitrage/',
                          data:{  
                              pk:$("#pk").val(),
                              csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val()
                          },
                          //datatype: 'json',
                          success:function(){
                              
                              // document.getElementById("strbtn").disabled = true;
                              // document.getElementById("stopbtn").disabled = true;
                              // document.getElementById("bot").disabled = false;
                              // setTimeout(change,14500)
                          }
                      })
                      }
                }
            })
          
        })
      function changestop(){
        document.getElementById("amount").disabled = false;
        document.getElementById("mode").disabled = false;
        document.getElementById("submit").innerHTML = 'Start';
        document.getElementById("submit").className = 'crypt-button-green-full';
        document.getElementById("submit").disabled = false
        canupdate = false
      }
      function changestart(){
        document.getElementById("amount").disabled = true;
        document.getElementById("mode").disabled = true;
        document.getElementById("submit").innerHTML = 'Stop';
        document.getElementById("submit").disabled = false
        document.getElementById("submit").className = 'crypt-button-red-full';
        canupdate = true
      }
      function exchange(){
        if (canupdate == true) {
            $.ajax({
                      type:'POST',
                      url:'/arbitrage/exchangeslive/',
                      datatype: 'json',
                      data:{  
                          pk:$("#pk").val(),
                          csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val()
                      },
                      success:function(jsdata){
                          if(jsdata){
                              
                            document.getElementById('firstvolume').innerHTML = '24h Vol: '+ String(jsdata['firstvolume']) + ' '+ String(jsdata['quote'])
                            document.getElementById('firstprice').innerHTML = String(jsdata['firstprice']) 
                            document.getElementById('firstsymbol').innerHTML = String(jsdata['firstsymb']) + ' Price'
                            document.getElementById('secvolume').innerHTML = '24h Vol: '+ String(jsdata['secvolume']) + ' '+ String(jsdata['quote'])
                            document.getElementById('secprice').innerHTML = String(jsdata['secprice']) 
                            document.getElementById('secsymbol').innerHTML = String(jsdata['secsymb']) + ' Price'
                              
                              
                          }
                              
                          setTimeout(exchange, 100500)
                      }
                  })}
              }

      function update(){
        if (true) {
            $.ajax({
                type:'POST',
                url:'/arbitrage/countidata/',
                data:{  
                    pk:$("#pk").val(),
                    csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val()
                },
                datatype: 'json',
                success:function(jsdata){
                    if(jsdata['tabletrade']){
                      document.getElementById('transactionempty').style.display = 'none';
                      document.getElementById('table-body').innerHTML = jsdata['tabletrade'] 
                      if (jsdata['amount'] != '') {
                        document.getElementById('amount').value = jsdata['amount'];
                      }   
                       
                      if (jsdata['cursus'] == 'Paper') {
                        
                        document.getElementById('paper').selected = 'selected';
                        
                      }else if (jsdata['cursus'] == 'Live'){
                        document.getElementById('live').selected = 'selected';
                        
                      }
                    }
                        
                    setTimeout(update, 10000)
                },
                error: function(){
                  setTimeout(update, 20000)
                }
            })}
        }

        function updateelapsed(){
          if (true) {
            $.ajax({
                type:'POST',
                url:'/live/elapsed/',
                data:{
                    pk:$("#pk").val(),
                    type: 'arbitrage',
                    csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val()
                },

                datatype: 'json',
                success:function(jsdata){
                    
                    if (jsdata['elapsed'] != '') {
                      if(jsdata['elapsed'].includes('second') || jsdata['elapsed'].includes('now') ){
                        document.getElementById('elapsed').innerHTML = 'Running'
                      }else{
                        document.getElementById('elapsed').innerHTML = jsdata['elapsed']
                      }
                      
                    }
                        
                    setTimeout(updateelapsed, 10000)
                },
                error:function(){
                  setTimeout(updateelapsed, 10000)
                }
            })}
        }

        
    </script>
    <script type="text/javascript">
       $(document).ready(function(){

            (async function getprice(){
                let binance = new ccxt.binance ({
                apiKey: 'YOUR_PUBLIC_API_KEY',
                secret: 'YOUR_SECRET_PRIVATE_KEY',
                })

                var pair = ['BTC/USDT','ETH/USDT','LTC/USDT', 'BCH/USDT', 'XRP/USDT', 'EOS/USDT', 'LINK/USDT','XTZ/USDT']
                
                var locationprice = ['pricebtcusdt', 'priceethusdt', 'priceltcusdt', 'pricebchusdt','pricexrpusdt', 'priceeosusdt', 'pricelinkusdt', 'pricextzusdt']
                
                var locationvolume = ['volumebtcusdt', 'volumeethusdt', 'volumeltcusdt', 'volumebchusdt','volumexrpusdt', 'volumeeosusdt', 'volumelinkusdt', 'volumextzusdt']

                var locationchange = ['changebtcusdt', 'changeethusdt', 'changeltcusdt', 'changebchusdt','changexrpusdt', 'changeeosusdt', 'changelinkusdt', 'changextzusdt']


                var price = await binance.fetchTickers(pair)
                var len = pair.length
                for (var i = 0; i < len; i++) {
                    if ( price[pair[i]].symbol.includes('BTC') && price[pair[i]].symbol != 'BTC/USDT' ) {
                        symbole = '₿'

                    }else{
                        symbole = '$'
                    }
                    document.getElementById(locationprice[i]).innerHTML = symbole+price[pair[i]].last
                    document.getElementById(locationvolume[i]).innerHTML = symbole+price[pair[i]].quoteVolume
                    document.getElementById(locationchange[i]).innerHTML = price[pair[i]].percentage+'%'
                    if (parseFloat(price[pair[i]].percentage) > 0) {
                        document.getElementById(locationchange[i]).className = 'crypt-up'
                    }else{
                        document.getElementById(locationchange[i]).className = 'crypt-down'
                    }
                
                 }

                setTimeout(getprice,5500)
            })() ;
        })
    </script>
{% endblock scripts %}